<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <meta name="requires-role" content="admin">
  <title>إدارة المندوبين — بصمة سوداء</title>
    
    <!-- Page Guard -->
    <script src="js/guard.js"></script>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts - Cairo -->
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">
    
    <!-- Firebase Scripts -->
    <script type="module" src="js/firebase-config-cdn.js"></script>
    <script type="module" src="js/firebase-database-cdn.js"></script>
    
    <!-- Arabic Numbers Support -->
    <script src="js/arabic-numbers.js"></script>
    
    <style>
        body { 
            font-family: 'Cairo', sans-serif; 
            background-color: #f8f9fa; 
            padding-top: 70px; 
        }
        .navbar { 
            background-color: #2c3e50; 
            position: fixed; 
            top: 0; 
            width: 100%; 
            z-index: 1030; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .navbar-brand, .nav-link { color: white !important; }
        .card { 
            margin-bottom: 20px; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.08); 
        }
        .card-header { 
            font-weight: 600; 
        }
        .table thead.table-dark th { 
            vertical-align: middle; 
        }
        .btn-primary { 
            background-color: #2c3e50; 
            border-color: #2c3e50; 
        }
        .btn-primary:hover { 
            background-color: #1a252f; 
            border-color: #1a252f; 
        }
        .status-badge {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
        }
        .status-active {
            background: #d4edda;
            color: #155724;
        }
        .status-inactive {
            background: #f8d7da;
            color: #721c24;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container">
            <span class="navbar-brand">بصمة سوداء</span>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>

            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <!-- Navigation will be populated by navigation.js -->
                </ul>
            </div>
        </div>
    </nav>

    <div class="container-fluid py-4">
        <!-- Page Header -->
        <div class="row mb-4">
            <div class="col-12">
                <h2 class="text-center mb-3">
                    <i class="fas fa-users text-primary"></i> إدارة المندوبين
                </h2>
            </div>
        </div>

        <!-- Add New Rep Form -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0"><i class="fas fa-plus-circle"></i> إضافة مندوب جديد</h5>
                    </div>
                    <div class="card-body">
                        <form id="addRepForm">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="repName" class="form-label">اسم المندوب *</label>
                                    <input type="text" class="form-control" id="repName" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="repPhone" class="form-label">رقم الهاتف *</label>
                                    <input type="tel" class="form-control arabic-number-field" id="repPhone" required>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="repEmail" class="form-label">البريد الإلكتروني</label>
                                    <input type="email" class="form-control" id="repEmail">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="repActive" class="form-label">الحالة</label>
                                    <select class="form-select" id="repActive">
                                        <option value="true" selected>نشط</option>
                                        <option value="false">غير نشط</option>
                                    </select>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="repNotes" class="form-label">ملاحظات</label>
                                <textarea class="form-control" id="repNotes" rows="3"></textarea>
                            </div>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save"></i> حفظ المندوب
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Reps List -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0"><i class="fas fa-list"></i> قائمة المندوبين</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead class="table-dark">
                                    <tr>
                                        <th>الاسم</th>
                                        <th>رقم الهاتف</th>
                                        <th>البريد الإلكتروني</th>
                                        <th>الحالة</th>
                                        <th>تاريخ الإنشاء</th>
                                        <th>الإجراءات</th>
                                    </tr>
                                </thead>
                                <tbody id="repsList">
                                    <!-- Reps data will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Rep Modal -->
    <div class="modal fade" id="editRepModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">تعديل بيانات المندوب</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editRepForm">
                        <input type="hidden" id="editRepId">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="editRepName" class="form-label">اسم المندوب *</label>
                                <input type="text" class="form-control" id="editRepName" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="editRepPhone" class="form-label">رقم الهاتف *</label>
                                <input type="tel" class="form-control arabic-number-field" id="editRepPhone" required>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="editRepEmail" class="form-label">البريد الإلكتروني</label>
                                <input type="email" class="form-control" id="editRepEmail">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="editRepActive" class="form-label">الحالة</label>
                                <select class="form-select" id="editRepActive">
                                    <option value="true">نشط</option>
                                    <option value="false">غير نشط</option>
                                </select>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="editRepNotes" class="form-label">ملاحظات</label>
                            <textarea class="form-control" id="editRepNotes" rows="3"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                    <button type="button" class="btn btn-primary" onclick="updateRep()">حفظ التغييرات</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Navigation Script -->
    <script src="js/navigation.js"></script>
    
    <script>
        let repsData = [];
        let currentEditId = null;

        // ===== دعم الأرقام العربية والإنجليزية =====
        function convertArabicToEnglishNumbers(str) {
            if (!str) return '';
            const map = {
                '٠': '0', '١': '1', '٢': '2', '٣': '3', '٤': '4',
                '٥': '5', '٦': '6', '٧': '7', '٨': '8', '٩': '9'
            };
            return str.toString().replace(/[٠-٩]/g, m => map[m] || m);
        }

        function convertEnglishToArabicNumbers(str) {
            if (!str) return '';
            const map = {
                '0': '٠', '1': '١', '2': '٢', '3': '٣', '4': '٤',
                '5': '٥', '6': '٦', '7': '٧', '8': '٨', '9': '٩'
            };
            return str.toString().replace(/[0-9]/g, m => map[m] || m);
        }

        function setupArabicNumberSupport() {
            document.querySelectorAll('.arabic-number-field').forEach(field => {
                field.addEventListener('input', function() {
                    const pos = this.selectionStart;
                    const cv = convertArabicToEnglishNumbers(this.value);
                    if (cv !== this.value) {
                        this.value = cv;
                        this.setSelectionRange(pos, pos);
                    }
                });
            });
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            setupArabicNumberSupport();
            loadRepsData();
            // Initialize navigation
            if (typeof initNavigation === 'function') {
                initNavigation('maintenance-reps');
            }
        });

        // Load reps data from Firebase
        async function loadRepsData() {
            try {
                if (!window.firebaseDatabase) {
                    console.error('Firebase database not initialized');
                    return;
                }

                repsData = await window.firebaseDatabase.getReps();
                displayReps();
            } catch (error) {
                console.error('Error loading reps data:', error);
                showAlert('error', 'حدث خطأ في تحميل بيانات المندوبين');
            }
        }

        // Display reps in table
        function displayReps() {
            const tbody = document.getElementById('repsList');
            tbody.innerHTML = '';

            if (repsData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center">لا توجد بيانات</td></tr>';
                return;
            }

            repsData.forEach(rep => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${rep.name}</td>
                    <td>${rep.phone}</td>
                    <td>${rep.email || '-'}</td>
                    <td>
                        <span class="status-badge status-${rep.active ? 'active' : 'inactive'}">
                            ${rep.active ? 'نشط' : 'غير نشط'}
                        </span>
                    </td>
                    <td>${rep.createdAt ? new Date(rep.createdAt.seconds * 1000).toLocaleDateString('ar-SA') : '-'}</td>
                    <td>
                        <button class="btn btn-sm btn-warning me-1" onclick="editRep('${rep.id}')">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="deleteRep('${rep.id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // Add new rep
        document.getElementById('addRepForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const repData = {
                name: document.getElementById('repName').value,
                phone: document.getElementById('repPhone').value,
                email: document.getElementById('repEmail').value,
                active: document.getElementById('repActive').value === 'true',
                notes: document.getElementById('repNotes').value
            };

            try {
                await window.firebaseDatabase.addRep(repData);
                showAlert('success', 'تم إضافة المندوب بنجاح');
                document.getElementById('addRepForm').reset();
                loadRepsData();
            } catch (error) {
                console.error('Error adding rep:', error);
                showAlert('error', 'حدث خطأ في إضافة المندوب');
            }
        });

        // Edit rep
        function editRep(repId) {
            const rep = repsData.find(r => r.id === repId);
            if (!rep) return;

            currentEditId = repId;
            document.getElementById('editRepId').value = repId;
            document.getElementById('editRepName').value = rep.name;
            document.getElementById('editRepPhone').value = rep.phone;
            document.getElementById('editRepEmail').value = rep.email || '';
            document.getElementById('editRepActive').value = rep.active ? 'true' : 'false';
            document.getElementById('editRepNotes').value = rep.notes || '';

            new bootstrap.Modal(document.getElementById('editRepModal')).show();
        }

        // Update rep
        async function updateRep() {
            if (!currentEditId) return;

            const repData = {
                name: document.getElementById('editRepName').value,
                phone: document.getElementById('editRepPhone').value,
                email: document.getElementById('editRepEmail').value,
                active: document.getElementById('editRepActive').value === 'true',
                notes: document.getElementById('editRepNotes').value
            };

            try {
                await window.firebaseDatabase.updateRep(currentEditId, repData);
                showAlert('success', 'تم تحديث بيانات المندوب بنجاح');
                bootstrap.Modal.getInstance(document.getElementById('editRepModal')).hide();
                loadRepsData();
            } catch (error) {
                console.error('Error updating rep:', error);
                showAlert('error', 'حدث خطأ في تحديث بيانات المندوب');
            }
        }

        // Delete rep
        async function deleteRep(repId) {
            if (!confirm('هل أنت متأكد من حذف هذا المندوب؟')) return;

            try {
                await window.firebaseDatabase.deleteRep(repId);
                showAlert('success', 'تم حذف المندوب بنجاح');
                loadRepsData();
            } catch (error) {
                console.error('Error deleting rep:', error);
                showAlert('error', 'حدث خطأ في حذف المندوب');
            }
        }

        // Show alert
        function showAlert(type, message) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type === 'error' ? 'danger' : type} alert-dismissible fade show`;
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            document.body.insertBefore(alertDiv, document.body.firstChild);
            
            setTimeout(() => {
                alertDiv.remove();
            }, 5000);
        }
    </script>
</body>
</html>
