<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ููุญุฉ ุงูุชุญูู โ ุงูุตูุฑู ููุงุชุตุงูุงุช</title>

  <!-- ููุณ ุงูุฎุท/ุงูููุชุจุงุช ุงููุณุชุฎุฏูุฉ ูู ุงููุงูุจ -->
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

  <style>
    body { font-family: 'Cairo', sans-serif; background-color: #f8f9fa; padding-top: 70px; }
    .navbar { 
      background-color: #2c3e50; 
      position: fixed; 
      top: 0; 
      width: 100%; 
      z-index: 1030; 
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .navbar-brand, .nav-link { color: white !important; }
    /* ููุณ ุงูุชูุณููุงุช ุงููุฎุตุตุฉ ูู ุงูููู ุงูุฃุตูู */
    .card { border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); transition: transform 0.2s ease-in-out; }
    .card:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.15); }
    .card-body { padding: 1.25rem; }
    .card-header { border-radius: 8px 8px 0 0 !important; font-weight: 600; }
    .card.bg-primary, .card.bg-success, .card.bg-info, .card.bg-warning {
      border: none; box-shadow: 0 3px 6px rgba(0,0,0,0.16);
    }
    .card.bg-primary:hover, .card.bg-success:hover, .card.bg-info:hover, .card.bg-warning:hover {
      transform: translateY(-3px); box-shadow: 0 6px 12px rgba(0,0,0,0.2);
    }
    @media (max-width: 768px) {
      .card-body { padding: 1rem; }
      h3 { font-size: 1.5rem; }
      .fa-2x { font-size: 1.5em; }
    }
  </style>
</head>
<body>

  <!-- ุดุฑูุท ุงูุชููู -->
  <nav class="navbar navbar-expand-lg navbar-dark">
    <div class="container">
      <a class="navbar-brand" href="index.html">ุงูุตูุฑู ููุงุชุตุงูุงุช</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
        <span class="navbar-toggler-icon"></span>
      </button>

      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav me-auto">
          <li class="nav-item">
            <a class="nav-link active" href="dashboard.html"><i class="fas fa-tachometer-alt"></i> ููุญุฉ ุงูุชุญูู</a>
          </li>

          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" id="inventoryDropdown" role="button" data-bs-toggle="dropdown">
              <i class="fas fa-boxes"></i> ุฅุฏุงุฑุฉ ุงููุฎุฒูู
            </a>
            <ul class="dropdown-menu">
              <li><a class="dropdown-item" href="inventory_summary.html"><i class="fas fa-chart-bar"></i> ููุฎุต ุงููุฎุฒูู</a></li>
              <li><a class="dropdown-item" href="search.html"><i class="fas fa-search"></i> ุงูุจุญุซ ูู ุงููุฎุฒูู</a></li>
              <li><hr class="dropdown-divider"></li>
              <li><a class="dropdown-item" href="add_accessory.html"><i class="fas fa-plus"></i> ุฅุถุงูุฉ ุฃูุณุณูุงุฑ</a></li>
              <li><a class="dropdown-item" href="list_accessories_simple.html"><i class="fas fa-box"></i> ูุฎุฒูู ุงูุฃูุณุณูุงุฑุงุช</a></li>
            </ul>
          </li>

          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" id="salesDropdown" role="button" data-bs-toggle="dropdown">
              <i class="fas fa-shopping-cart"></i> ุฅุฏุงุฑุฉ ุงููุจูุนุงุช
            </a>
            <ul class="dropdown-menu">
              <li><a class="dropdown-item" href="list_sales.html"><i class="fas fa-list"></i> ูุงุฆูุฉ ุงููุจูุนุงุช</a></li>
              <li><a class="dropdown-item" href="create_sale.html"><i class="fas fa-plus-circle"></i> ุฅูุดุงุก ุนูููุฉ ุจูุน ุฌุฏูุฏุฉ</a></li>
            </ul>
          </li>

          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" id="phoneDropdown" role="button" data-bs-toggle="dropdown">
              <i class="fas fa-mobile-alt"></i> ุฅุฏุงุฑุฉ ุงูููุงุชู
            </a>
            <ul class="dropdown-menu">
              <li><a class="dropdown-item" href="add_new_phone.html"><i class="fas fa-mobile"></i> ูุงุชู ุฌุฏูุฏ</a></li>
              <li><a class="dropdown-item" href="add_used_phone.html"><i class="fas fa-mobile-alt"></i> ูุงุชู ูุณุชุนูู</a></li>
            </ul>
          </li>

          <li class="nav-item">
            <a class="nav-link" href="#" onclick="logout()"><i class="fas fa-sign-out-alt"></i> ุชุณุฌูู ุงูุฎุฑูุฌ</a>
          </li>
        </ul>
      </div>
    </div>
  </nav>

<div class="container-fluid mt-4">
  <!-- Main Header -->
  <div class="row mb-4">
    <div class="col-12">
      <h2 class="text-center mb-3">
        <i class="fas fa-tachometer-alt text-primary"></i> ููุญุฉ ุงูุชุญูู
      </h2>
    </div>
  </div>

  <!-- Inventory Overview Cards -->
  <div class="row mb-4">
    <div class="col-md-3">
      <div class="card bg-primary text-white h-100">
        <div class="card-body text-center py-3">
          <i class="fas fa-mobile-alt fa-2x mb-2"></i>
          <h6 class="card-title mb-1">ุฅุฌูุงูู ุงูููุงุชู</h6>
          <h3 class="mb-0" id="total_phones">0</h3>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card bg-success text-white h-100">
        <div class="card-body text-center py-3">
          <i class="fas fa-cash-register fa-2x mb-2"></i>
          <h6 class="card-title mb-1">ุนุฏุฏ ุงููุจูุนุงุช</h6>
          <h3 class="mb-0" id="total_sales_count">0</h3>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card bg-info text-white h-100">
        <div class="card-body text-center py-3">
          <i class="fas fa-money-bill-wave fa-2x mb-2"></i>
          <h6 class="card-title mb-1">ุฅุฌูุงูู ุงููุจูุนุงุช</h6>
          <h3 class="mb-0" id="total_sales_amount">0</h3>
          <small>ุฑูุงู</small>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card bg-warning text-white h-100">
        <div class="card-body text-center py-3">
          <i class="fas fa-coins fa-2x mb-2"></i>
          <h6 class="card-title mb-1">ุงูุฑุจุญ ุงููุนูู</h6>
          <h3 class="mb-0" id="total_actual_profit">0</h3>
          <small>ุฑูุงู</small>
        </div>
      </div>
    </div>
  </div>

  <!-- Financial Details Cards -->
  <div class="row mb-4">
    <div class="col-md-4">
      <div class="card bg-light h-100">
        <div class="card-header bg-primary text-white">
          <h5 class="mb-0"><i class="fas fa-shopping-cart"></i> ุงูููู ุงูุดุฑุงุฆูุฉ</h5>
        </div>
        <div class="card-body text-center">
          <h3 class="text-primary" id="total_purchase_value">0.00 ุฑูุงู</h3>
          <p class="text-muted">ุฅุฌูุงูู ูููุฉ ุดุฑุงุก ุงููุฎุฒูู ุงููุชุงุญ</p>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card bg-light h-100">
        <div class="card-header bg-success text-white">
          <h5 class="mb-0"><i class="fas fa-tags"></i> ุงูููู ุงูุจูุนูุฉ</h5>
        </div>
        <div class="card-body text-center">
          <h3 class="text-success" id="total_selling_value">0.00 ุฑูุงู</h3>
          <p class="text-muted">ุฅุฌูุงูู ูููุฉ ุจูุน ุงููุฎุฒูู ุงููุชุงุญ</p>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card bg-light h-100">
        <div class="card-header bg-warning text-white">
          <h5 class="mb-0"><i class="fas fa-chart-line"></i> ุงูุฑุจุญ ุงููุชููุน</h5>
        </div>
        <div class="card-body text-center">
          <h3 class="text-warning" id="total_expected_profit">0.00 ุฑูุงู</h3>
          <p class="text-muted">ุงูุฑุจุญ ุงููุชููุน ูู ุงููุฎุฒูู ุงููุชุงุญ</p>
        </div>
      </div>
    </div>
  </div>


  <!-- Sales Performance Cards -->
  <div class="row mb-4">
    <div class="col-md-4">
      <div class="card bg-light h-100">
        <div class="card-header bg-success text-white">
          <h5 class="mb-0"><i class="fas fa-receipt"></i> ุงููุจูุนุงุช ูุจู ุงูุถุฑูุจุฉ</h5>
        </div>
        <div class="card-body text-center">
          <h3 class="text-success" id="total_sales_subtotal">0.00 ุฑูุงู</h3>
          <p class="text-muted">ุฅุฌูุงูู ุงููุจูุนุงุช ูุจู ุงูุถุฑูุจุฉ</p>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card bg-light h-100">
        <div class="card-header bg-danger text-white">
          <h5 class="mb-0"><i class="fas fa-percentage"></i> ุฅุฌูุงูู ุงูุถุฑูุจุฉ</h5>
        </div>
        <div class="card-body text-center">
          <h3 class="text-danger" id="total_vat_amount">0.00 ุฑูุงู</h3>
          <p class="text-muted">ุฅุฌูุงูู ุถุฑูุจุฉ ุงููููุฉ ุงููุถุงูุฉ</p>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card bg-light h-100">
        <div class="card-header bg-info text-white">
          <h5 class="mb-0"><i class="fas fa-chart-pie"></i> ูุณุจุฉ ุงูุฑุจุญ</h5>
        </div>
        <div class="card-body text-center">
          <h3 class="text-info" id="profit_ratio">0%</h3>
          <p class="text-muted">ูุณุจุฉ ุงูุฑุจุญ ูู ุงููุจูุนุงุช</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Quick Actions -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="card">
        <div class="card-header bg-primary text-white">
          <h5 class="mb-0"><i class="fas fa-bolt"></i> ุฅุฌุฑุงุกุงุช ุณุฑูุนุฉ</h5>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-3 mb-2">
              <a href="create_sale.html" class="btn btn-success btn-lg w-100">
                <i class="fas fa-plus-circle"></i><br>ุฅูุดุงุก ุนูููุฉ ุจูุน
              </a>
            </div>
            <div class="col-md-3 mb-2">
              <a href="add_new_phone.html" class="btn btn-primary btn-lg w-100">
                <i class="fas fa-mobile"></i><br>ุฅุถุงูุฉ ูุงุชู ุฌุฏูุฏ
              </a>
            </div>
            <div class="col-md-3 mb-2">
              <a href="add_accessory.html" class="btn btn-info btn-lg w-100">
                <i class="fas fa-box"></i><br>ุฅุถุงูุฉ ุฃูุณุณูุงุฑ
              </a>
            </div>
            <div class="col-md-3 mb-2">
              <a href="search.html" class="btn btn-warning btn-lg w-100">
                <i class="fas fa-search"></i><br>ุงูุจุญุซ ูู ุงููุฎุฒูู
              </a>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Recent Sales -->
  <div class="row">
    <div class="col-12">
      <div class="card">
        <div class="card-header bg-success text-white">
          <h5 class="mb-0"><i class="fas fa-history"></i> ุขุฎุฑ ุงููุจูุนุงุช</h5>
        </div>
        <div class="card-body" id="recent_sales_wrap">
          <!-- ูุงุฌูุฉ ููุท: ุงุนุฑุถ ุฑุณุงูุฉ ูุงุฑุบุฉ. ููููู ูุงุญููุง ููุคูุง ุนุจุฑ JS ูู API -->
          <div class="text-center py-4">
            <i class="fas fa-shopping-cart fa-3x text-muted mb-3"></i>
            <h5 class="text-muted">ูุง ุชูุฌุฏ ูุจูุนุงุช ุญุฏูุซุฉ</h5>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ููุชุจุงุช JS ููุณูุง -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<!-- Firebase Configuration -->
<script type="module" src="js/firebase-config.js"></script>
<script type="module" src="js/firebase-database.js"></script>
<script type="module" src="js/firebase-storage-manager.js"></script>

<!-- ูุธุงู ููุญุฉ ุงูุชุญูู ูุน ุงูุชุญูู ูู ุชุณุฌูู ุงูุฏุฎูู -->
<script>
  // ุงูุชุญูู ูู ุชุณุฌูู ุงูุฏุฎูู
  function checkLogin() {
    const currentUser = localStorage.getItem('current_user');
    if (!currentUser) {
      // ุฅุนุงุฏุฉ ุชูุฌูู ูุตูุญุฉ ุชุณุฌูู ุงูุฏุฎูู
      alert('ูุฌุจ ุชุณุฌูู ุงูุฏุฎูู ุฃููุงู');
      window.location.href = 'login.html';
      return false;
    }
    return true;
  }

  // ุชุณุฌูู ุงูุฎุฑูุฌ
  function logout() {
    if (confirm('ูู ุฃูุช ูุชุฃูุฏ ูู ุชุณุฌูู ุงูุฎุฑูุฌุ')) {
      localStorage.removeItem('current_user');
      alert('ุชู ุชุณุฌูู ุงูุฎุฑูุฌ ุจูุฌุงุญ');
      window.location.href = 'index.html';
    }
  }

  // ---------- ุฃุฏูุงุช ูุณุงุนุฏุฉ ููููุช/ุงูุชุงุฑูุฎ ----------
  // ูุญููู ุฃู ูุฏุฎู ุชุงุฑูุฎ (Date | ISO string | number | Firestore Timestamp | {seconds/_seconds, nanoseconds/_nanoseconds}) ุฅูู Date ุตุงูุญ
  function normalizeToDate(v) {
    if (v == null) return null;

    // 1) Date ุฌุงูุฒ
    if (v instanceof Date) {
      return isNaN(v.getTime()) ? null : v;
    }

    // 2) Firestore Timestamp: toDate()
    if (typeof v === 'object') {
      if (typeof v.toDate === 'function') {
        const d = v.toDate();
        return isNaN(d?.getTime()) ? null : d;
      }
      // 3) ุดูู seconds/nanoseconds ุฃู _seconds/_nanoseconds
      if ('seconds' in v || '_seconds' in v) {
        const sec  = Number(v.seconds ?? v._seconds ?? 0);
        const nsec = Number(v.nanoseconds ?? v._nanoseconds ?? 0);
        const ms = (sec * 1000) + Math.floor(nsec / 1e6);
        const d = new Date(ms);
        return isNaN(d.getTime()) ? null : d;
      }
    }

    // 4) ุฑูู: ms ุฃู s
    if (typeof v === 'number') {
      const ms = v > 1e12 ? v : v * 1000; // ุฅุฐุง ุฃูู ูู 1e12 ููุชุฑุถ ุซูุงูู
      const d = new Date(ms);
      return isNaN(d.getTime()) ? null : d;
    }

    // 5) ุณุชุฑูู: ISO ุฃู ุฑูููุฉ
    if (typeof v === 'string') {
      const s = v.trim();
      if (/^\d+$/.test(s)) {
        const n = parseInt(s, 10);
        const ms = n > 1e12 ? n : n * 1000;
        const d = new Date(ms);
        return isNaN(d.getTime()) ? null : d;
      }
      const d = new Date(s); // ูุซู "2025-09-20T11:34:48.797Z"
      return isNaN(d.getTime()) ? null : d;
    }

    return null;
  }

  // ูุฑุฌูุน ุฃูุถู ุชุงุฑูุฎ ููุฌูุฏ ูู ุงูุณุฌู
  function getSaleDateValue(sale) {
    return (
      normalizeToDate(sale?.date_created) ||
      normalizeToDate(sale?.date_added)   ||
      normalizeToDate(sale?.createdAt)    ||
      normalizeToDate(sale?.created_at)   ||
      null
    );
  }

  // ุชุญููู ุงูุฃุฑูุงู ุงูุนุฑุจูุฉ ุฅูู ูุงุชูููุฉ โ ูุฏุนู ุงููุฏุฎูุงุช ุงูุฑูููุฉ
  function convertToLatinNumbers(input) {
    if (input == null) return '';
    const str = String(input);
    const map = {'ู':'0','ูก':'1','ูข':'2','ูฃ':'3','ูค':'4','ูฅ':'5','ูฆ':'6','ูง':'7','ูจ':'8','ูฉ':'9'};
    return str.replace(/[ู-ูฉ]/g, d => map[d] || d);
  }

  // ุงูุชุญูู ูู ุจูุน ุงููุงุชู
  function isPhoneSold(phoneId, salesData = []) {
    try {
      const sales = salesData.length > 0 ? salesData : JSON.parse(localStorage.getItem('sales') || '[]');
      return sales.some(sale =>
        Array.isArray(sale.items) &&
        sale.items.some(item => item.type === 'phone' && (item.id === phoneId || item.phone_id === phoneId))
      );
    } catch (error) {
      console.error('โ ุฎุทุฃ ูู ุงูุชุญูู ูู ุจูุน ุงููุงุชู:', error);
      return false;
    }
  }

  // ุชุญุฏูุซ ููุญุฉ ุงูุชุญูู ุจุงูุจูุงูุงุช ุงูุญููููุฉ
  async function updateDashboard() {
    try {
      // ุฌูุจ ุงูุจูุงูุงุช ูู Firebase ุฃู ุงูุชุฎุฒูู ุงููุญูู
      let phones = [];
      let accessories = [];
      let sales = [];
      
      if (window.storage && window.storage.isFirebaseAvailable) {
        // ุงุณุชุฎุฏุงู Firebase
        phones = await window.storage.getPhones();
        accessories = await window.storage.getAccessories();
        sales = await window.storage.getSales();
      } else {
        // ุงุณุชุฎุฏุงู LocalStorage ูุจุฏูู
        phones = JSON.parse(localStorage.getItem('phones') || '[]');
        accessories = JSON.parse(localStorage.getItem('accessories') || '[]');
        sales = JSON.parse(localStorage.getItem('sales') || '[]');
      }

      // ุชุตููุฉ ุงูููุงุชู ุงููุจุงุนุฉ - ุฅุจูุงุก ุงูููุงุชู ุงููุชุงุญุฉ ููุท
      const availablePhones = phones.filter(phone => {
        const phoneId = phone.id || phone.phone_number;
        return phoneId && !isPhoneSold(phoneId, sales);
      });

      console.log('๐ฑ ุงูููุงุชู ุงููุชุงุญุฉ:', availablePhones.length, 'ูู ุฃุตู', phones.length);

      // ุชุญุฏูุซ ุฅุญุตุงุฆูุงุช ุงูููุงุชู (ุงูููุงุชู ุงููุชุงุญุฉ ููุท)
      const totalPhones = availablePhones.length;
      const totalPurchaseValue = availablePhones.reduce((sum, phone) => sum + (phone.purchase_price || 0), 0);
      const totalSellingValue = availablePhones.reduce((sum, phone) => sum + (phone.selling_price || 0), 0);
      const totalExpectedProfit = totalSellingValue - totalPurchaseValue;

      document.getElementById('total_phones').textContent = convertToLatinNumbers(totalPhones);
      document.getElementById('total_purchase_value').textContent = convertToLatinNumbers(totalPurchaseValue.toFixed(2)) + ' ุฑูุงู';
      document.getElementById('total_selling_value').textContent = convertToLatinNumbers(totalSellingValue.toFixed(2)) + ' ุฑูุงู';
      document.getElementById('total_expected_profit').textContent = convertToLatinNumbers(totalExpectedProfit.toFixed(2)) + ' ุฑูุงู';


      // ุชุญุฏูุซ ุฅุญุตุงุฆูุงุช ุงููุจูุนุงุช
      const totalSales = sales.length;
      const totalSalesAmount = sales.reduce((sum, sale) => sum + (sale.total_amount || 0), 0);
      const totalSalesSubtotal = sales.reduce((sum, sale) => sum + (sale.subtotal || 0), 0);
      const totalVatAmount = sales.reduce((sum, sale) => sum + (sale.vat_amount || 0), 0);

      document.getElementById('total_sales_count').textContent = convertToLatinNumbers(totalSales);
      document.getElementById('total_sales_amount').textContent = convertToLatinNumbers(totalSalesAmount.toFixed(0));
      document.getElementById('total_sales_subtotal').textContent = convertToLatinNumbers(totalSalesSubtotal.toFixed(2)) + ' ุฑูุงู';
      document.getElementById('total_vat_amount').textContent = convertToLatinNumbers(totalVatAmount.toFixed(2)) + ' ุฑูุงู';
      document.getElementById('total_actual_profit').textContent = convertToLatinNumbers((totalSalesSubtotal * 0.2).toFixed(2)) + ' ุฑูุงู'; // ุชูุฏูุฑ 20% ุฑุจุญ

      // ุญุณุงุจ ูุณุจุฉ ุงูุฑุจุญ
      const profitRatio = totalSalesSubtotal > 0 ? 20 : 0; // ูุณุจุฉ ุชูุฏูุฑูุฉ
      document.getElementById('profit_ratio').textContent = convertToLatinNumbers(profitRatio.toFixed(1)) + '%';

    } catch (error) {
      console.error('ุฎุทุฃ ูู ุชุญุฏูุซ ููุญุฉ ุงูุชุญูู:', error);
    }
  }

  // ุชููุฆุฉ ุงูุตูุญุฉ
  document.addEventListener('DOMContentLoaded', async function() {
    // ุงูุชุญูู ูู ุชุณุฌูู ุงูุฏุฎูู ุฃููุงู
    if (!checkLogin()) return;

    // ุงูุชุธุงุฑ ุชุญููู Firebase
    await new Promise(resolve => setTimeout(resolve, 1000));

    // ุชุญุฏูุซ ููุญุฉ ุงูุชุญูู
    await updateDashboard();

    // ุชุญุฏูุซ ุงูุจูุงูุงุช ูู 10 ุซูุงูู
    setInterval(async () => {
      await updateDashboard();
    }, 10000);
  });
</script>
</body>
</html>
