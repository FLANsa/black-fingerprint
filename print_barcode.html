<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ â€” Ø§Ù„ØµÙ‚Ø±ÙŠ Ù„Ù„Ø§ØªØµØ§Ù„Ø§Øª</title>

  <!-- Ø®Ø·ÙˆØ· ÙˆØ³ØªØ§ÙŠÙ„ Ø¹Ø§Ù… -->
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet" />

  <!-- Ù…ÙƒØªØ¨Ø§Øª Ø§Ù„ØªØµØ¯ÙŠØ± -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
  <script src="js/arabic-font.js"></script>

  <style>
    :root { --card-bg: #ffffff; --muted:#cfcfcf; }
    body { font-family: 'Cairo', sans-serif; background:#f8f9fa; margin:0; padding:24px; }
    .container { max-width: 900px; margin: 0 auto; }
    .card {
      background: var(--card-bg);
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      box-shadow: 0 10px 20px rgba(0,0,0,0.05);
    }
    .card-header {
      padding: 16px 20px;
      border-bottom: 1px solid #e5e7eb;
      display:flex; align-items:center; justify-content:space-between;
    }
    .card-header h3 { margin:0; font-size: 1.1rem; font-weight: 700; }
    .card-body { padding: 20px; }

    /* Ù…Ø¹Ø§ÙŠÙ†Ø© Ø¯Ø§Ø®Ù„ Ø¥Ø·Ø§Ø± Ù…Ù†Ù‚Ø· */
    .sticker-preview{
      border:2px dashed var(--muted);
      padding:20px;
      background:#f9f9f9;
      border-radius:10px;
      display:flex;
      justify-content:center;
      margin-bottom: 18px;
    }

    /* Ø­Ø¬Ù… Ø§Ù„Ù…Ù„ØµÙ‚ Ù„Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©: 6cm Ã— 3cm (Ø£ÙƒØ¨Ø± Ù‚Ù„ÙŠÙ„Ø§Ù‹ Ù„Ø±Ø§Ø­Ø© Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©) */
    .sticker{
      width:6cm;
      height:3cm;
      background:#fff;
      border:1px solid #ddd;
      box-sizing:border-box;
      display:flex;
      flex-direction:column;
      padding:0.2cm;
      gap:0.15cm;
    }

    /* Ø§Ø³Ù… Ø§Ù„Ø´Ø±ÙƒØ© */
    .shop{
      text-align:center;
      font-weight:700;
      font-size:4mm; /* Ù…Ù‚Ø±ÙˆØ¡ */
      line-height:1.1;
      margin-bottom:0.1cm;
    }

    /* Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ ÙÙŠ Ø§Ù„ÙˆØ³Ø· */
    .sticker-barcode{
      flex:1;
      display:flex;
      align-items:center;
      justify-content:center;
      margin:-0.4cm 0 0 0; /* Ø±ÙØ¹ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ Ù„ÙŠÙƒÙˆÙ† ÙÙŠ Ø§Ù„Ù…Ù†ØªØµÙ ØªÙ…Ø§Ù…Ø§Ù‹ */
    }
    .sticker-barcode img{
      width:120%; /* Ø²ÙŠØ§Ø¯Ø© Ø¹Ø±Ø¶ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ Ø£ÙƒØ«Ø± */
      height:auto;
      max-height:1.0cm; /* Ø²ÙŠØ§Ø¯Ø© Ø§Ø±ØªÙØ§Ø¹ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ Ù‚Ù„ÙŠÙ„Ø§Ù‹ */
      image-rendering: crisp-edges;
      image-rendering: pixelated;
      display:block;
    }

    /* ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¬Ù‡Ø§Ø² Ø¨Ø§Ù„Ø£Ø³ÙÙ„: 3 Ø£Ø¹Ù…Ø¯Ø© */
    .rows{ 
      display:flex; 
      flex-direction:row; 
      gap:0.1cm; 
      justify-content:space-between;
      margin-top: -0.35cm; /* Ø±ÙØ¹ Ø§Ù„Ø¹Ù†Ø§ØµØ± Ù‚Ù„ÙŠÙ„Ø§Ù‹ Ø£ÙƒØ«Ø± */
    }
    .row2{
      display:flex;
      flex-direction:column;
      align-items:center;
      font-size:2.5mm;
      line-height:1.05;
      text-align:center;
      width: 33.333%;
    }
    .label{ color:#222; font-weight:600; text-align:center; }
    .value{ color:#000; font-weight:700; text-align:center; }

    /* Ø£Ø²Ø±Ø§Ø± */
    .actions { display:flex; gap:10px; flex-wrap:wrap; }
    .btn {
      appearance:none; border:0; padding:10px 14px; border-radius:10px; cursor:pointer;
      font-weight:700; font-family:inherit;
    }
    .btn-primary { background:#10b981; color:#fff; }
    .btn-outline { background:#fff; color:#111; border:1px solid #e5e7eb; }
    .btn i { margin-left:8px; }

    /* Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ù…ØªØµÙØ­ (Ù„Ù„Ø²Ø± "Ø·Ø¨Ø§Ø¹Ø© PDF") â€” Ø³Ù†Ø­ÙˆÙ‘Ù„ Ø¥Ù„Ù‰ PDF Ø£ÙˆÙ„Ø§Ù‹ Ø«Ù… Ù†Ø·Ø¨Ø¹ */
    @page{ size:auto; margin:5mm; }
    @media print{
      .no-print { display:none !important; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="card">
      <div class="card-header">
        <h3>Ø·Ø¨Ø§Ø¹Ø© Ø¨Ø§Ø±ÙƒÙˆØ¯ Ø§Ù„Ù‡Ø§ØªÙ</h3>
        <div class="actions no-print">
          <button id="btnDownloadPDF" class="btn btn-primary">
            ØªØ­Ù…ÙŠÙ„ PDF <i class="fa fa-download"></i>
          </button>
          <button id="btnPrintPDF" class="btn btn-outline">
            Ø·Ø¨Ø§Ø¹Ø© PDF <i class="fa fa-print"></i>
          </button>
          <a href="dashboard.html" class="btn btn-outline">Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</a>
        </div>
      </div>
      <div class="card-body">
        <div class="sticker-preview">
          <!-- Ø§Ù„Ù…Ù„ØµÙ‚ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ (Ø³ÙŠØªÙ… ØªØµÙˆÙŠØ±Ù‡ ÙˆØªØ­ÙˆÙŠÙ„Ù‡ Ø¥Ù„Ù‰ PDF) -->
          <div id="sticker" class="sticker">
            <!-- Ø§Ø³Ù… Ø§Ù„Ø´Ø±ÙƒØ© -->
            <div class="shop">Ø§Ù„ØµÙ‚Ø±ÙŠ Ù„Ù„Ø§ØªØµØ§Ù„Ø§Øª</div>

            <!-- Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ -->
            <div class="sticker-barcode">
              <canvas id="barcode-canvas"></canvas>
            </div>

            <!-- Ø§Ù„ØªÙØ§ØµÙŠÙ„ -->
            <div class="rows">
              <div class="row2">
                <div class="label">Ø±Ù‚Ù… Ø§Ù„Ø¬Ù‡Ø§Ø²</div>
                <div class="value" id="phone-number">-</div>
              </div>
              <div class="row2">
                <div class="label">Ù†Ø³Ø¨Ø© Ø§Ù„Ø¨Ø·Ø§Ø±ÙŠØ©</div>
                <div class="value" id="battery-level">-</div>
              </div>
              <div class="row2">
                <div class="label">Ø§Ù„Ø°Ø§ÙƒØ±Ø©</div>
                <div class="value" id="phone-memory">-</div>
              </div>
            </div>
          </div><!-- /sticker -->
        </div><!-- /preview -->
      </div>
    </div>
  </div>

  <script>
    (function () {
      // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ù„ØµÙ‚ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ Ø¹Ù„Ù‰ PDF: 40Ã—25 Ù…Ù„Ù…
      const STICKER_MM = { w: 40, h: 25 };
      const DPI = 300;                            // Ø¯Ù‚Ø© Ù…Ù…ØªØ§Ø²Ø© Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©
      const PX_PER_MM = DPI / 25.4;
      const TARGET_W = Math.round(STICKER_MM.w * PX_PER_MM);
      const TARGET_H = Math.round(STICKER_MM.h * PX_PER_MM);

      const stickerEl = document.getElementById('sticker');
      const btnDownload = document.getElementById('btnDownloadPDF');
      const btnPrint = document.getElementById('btnPrintPDF');

      if (!stickerEl) {
        console.error('Sticker element not found!');
        return;
      }

      // Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‡Ø§ØªÙ Ù…Ù† URL Ø£Ùˆ Firebase
      async function loadPhoneData() {
        try {
          // Ù…Ø­Ø§ÙˆÙ„Ø© Ø¬Ù„Ø¨ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ Ù…Ù† URL
          const urlParams = new URLSearchParams(window.location.search);
          const phoneNumber = urlParams.get('phone_number');
          
          console.log('ğŸ” Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù‡Ø§ØªÙ Ø¨Ø±Ù‚Ù…:', phoneNumber);
          
          if (phoneNumber && window.storage) {
            // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù‡Ø§ØªÙ ÙÙŠ Firebase
            const phones = await window.storage.getPhones();
            console.log('ğŸ“± Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù‡ÙˆØ§ØªÙ:', phones);
            
            const phone = phones.find(p => p.phone_number === phoneNumber);
            console.log('âœ… Ø§Ù„Ù‡Ø§ØªÙ Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯:', phone);
            
            if (phone) {
              // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ù…Ù† Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¬ÙˆØ§Ù„ Ø§Ù„Ù…Ø¯Ø®Ù„
              document.getElementById('phone-number').textContent = phone.phone_number || '-';
              document.getElementById('battery-level').textContent = phone.battery_level || '100';
              document.getElementById('phone-memory').textContent = phone.phone_memory || '32GB';
              
              console.log('ğŸ“Š Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¬ÙˆØ§Ù„ Ø§Ù„Ù…Ø­Ø¯Ø«Ø©:', {
                phone_number: phone.phone_number,
                battery_level: phone.battery_level,
                phone_memory: phone.phone_memory
              });
              
              // ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ Ø¨Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„ Ø§Ù„Ù…Ø¯Ø®Ù„
              generateBarcode(phone.phone_number || '1');
              return;
            } else {
              console.warn('âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù‡Ø§ØªÙ Ø¨Ø±Ù‚Ù…:', phoneNumber);
            }
          }
          
          // Ø¥Ø°Ø§ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§ØªØŒ Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
          const defaultNumber = phoneNumber || '1';
          console.log('âš ï¸ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©:', defaultNumber);
          
          document.getElementById('phone-number').textContent = defaultNumber;
          document.getElementById('battery-level').textContent = '100';
          document.getElementById('phone-memory').textContent = '32GB';
          
          // ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯
          generateBarcode(defaultNumber);
          
        } catch (error) {
          console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‡Ø§ØªÙ:', error);
          // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£
          document.getElementById('phone-number').textContent = '1';
          document.getElementById('battery-level').textContent = '100';
          document.getElementById('phone-memory').textContent = '32GB';
          generateBarcode('1');
        }
      }

      // ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯
      function generateBarcode(phoneNumber) {
        try {
          const canvas = document.getElementById('barcode-canvas');
          if (canvas && window.JsBarcode) {
            console.log('ğŸ”¢ ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ Ø¨Ø±Ù‚Ù…:', phoneNumber);
            
            JsBarcode(canvas, phoneNumber, {
              format: "CODE128",
              width: 3, /* Ø²ÙŠØ§Ø¯Ø© Ø¹Ø±Ø¶ Ø§Ù„Ø®Ø·ÙˆØ· Ø£ÙƒØ«Ø± */
              height: 35, /* Ø²ÙŠØ§Ø¯Ø© Ø§Ø±ØªÙØ§Ø¹ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ Ù‚Ù„ÙŠÙ„Ø§Ù‹ */
              displayValue: false,
              background: "#ffffff",
              lineColor: "#000000"
            });
            
            console.log('âœ… ØªÙ… ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ Ø¨Ù†Ø¬Ø§Ø­');
          } else {
            console.error('âŒ Canvas Ø£Ùˆ JsBarcode ØºÙŠØ± Ù…ØªØ§Ø­');
          }
        } catch (error) {
          console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯:', error);
        }
      }

      // Ù†Ù„ØªÙ‚Ø· Ø§Ù„Ù…Ù„ØµÙ‚ ÙƒØµÙˆØ±Ø© Ø¹Ø§Ù„ÙŠØ© Ø§Ù„Ø¯Ù‚Ø© (Canvas) Ø¹Ø¨Ø± html2canvas
      async function captureStickerCanvas() {
        // Ù†Ø¬Ø¹Ù„ Ø§Ù„Ù†Ø§ØªØ¬ ÙŠØ·Ø§Ø¨Ù‚ Ø£Ø¨Ø¹Ø§Ø¯ PDF Ø¨Ø§Ù„Ø¨ÙƒØ³Ù„ (Ø­ØªÙ‰ Ù„Ùˆ Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© 6Ã—3 Ø³Ù…)
        const scaleX = TARGET_W / stickerEl.clientWidth;
        const scaleY = TARGET_H / stickerEl.clientHeight;
        const scale = Math.min(scaleX, scaleY);

        return await html2canvas(stickerEl, {
          backgroundColor: '#ffffff',
          scale: scale,         // ÙŠØ±ÙØ¹ Ø§Ù„Ø¯Ù‚Ø©
          useCORS: true,        // Ù„Ù„Ø³Ù…Ø§Ø­ Ø¨ØªØ­Ù…ÙŠÙ„ ØµÙˆØ± Ù…Ù† Ù†ÙØ³ Ø§Ù„Ø£ØµÙ„
          logging: false,
          x: 0,
          y: 0,
          width: stickerEl.clientWidth,
          height: stickerEl.clientHeight
        });
      }

      // Ù†ØµØ¯Ø± PDF Ø¨Ø­Ø¬Ù… 40Ã—25 Ù…Ù…
      async function exportPdfBlobUrl() {
        const canvas = await captureStickerCanvas();
        const imgData = canvas.toDataURL('image/png');

        // Ù†Ø³ØªØ®Ø¯Ù… jsPDF Ø¨Ø£Ø¨Ø¹Ø§Ø¯ Ø§Ù„Ù…Ù„ØµÙ‚ (Landscape Ù„Ø£Ù† Ø§Ù„Ø¹Ø±Ø¶ Ø£ÙƒØ¨Ø±)
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF({
          orientation: 'landscape',
          unit: 'mm',
          format: [STICKER_MM.w, STICKER_MM.h]
        });

        // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…ÙˆØ¶Ø¹ Ù„ÙŠÙƒÙˆÙ† ÙÙŠ Ø§Ù„Ù…Ù†ØªØµÙ ØªÙ…Ø§Ù…Ø§Ù‹
        const imgWidth = STICKER_MM.w;
        const imgHeight = STICKER_MM.h;
        const x = 0;
        const y = 0;

        // Ù†Ø¶ÙŠÙ Ø§Ù„ØµÙˆØ±Ø© Ù„ØªÙ…Ù„Ø£ Ø§Ù„ØµÙØ­Ø© Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ Ù…Ø¹ ØªÙˆØ³ÙŠØ·
        doc.addImage(imgData, 'PNG', x, y, imgWidth, imgHeight, undefined, 'FAST');

        // Ù†ÙØ¹ÙŠØ¯ Blob URL Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…Ù‡ Ù„Ù„ØªØ­Ù…ÙŠÙ„ Ø£Ùˆ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©
        return doc.output('bloburl');
      }

      // ØªØ­Ù…ÙŠÙ„ ÙƒÙ…Ù„Ù
      async function downloadPdf() {
        const canvas = await captureStickerCanvas();
        const imgData = canvas.toDataURL('image/png');

        const { jsPDF } = window.jspdf;
        const doc = new jsPDF({
          orientation: 'landscape',
          unit: 'mm',
          format: [STICKER_MM.w, STICKER_MM.h]
        });
        
        // Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØµÙˆØ±Ø© ÙÙŠ Ø§Ù„Ù…Ù†ØªØµÙ ØªÙ…Ø§Ù…Ø§Ù‹
        doc.addImage(imgData, 'PNG', 0, 0, STICKER_MM.w, STICKER_MM.h, undefined, 'FAST');

        // Ø§Ø³Ù… Ø§Ù„Ù…Ù„Ù ÙŠØªØ¶Ù…Ù† Ø±Ù‚Ù… Ø§Ù„Ø¬Ù‡Ø§Ø²
        const phoneNumber = document.getElementById('phone-number').textContent || 'phone';
        const fileName = `barcode_${phoneNumber}.pdf`;
        doc.save(fileName);
      }

      // Ø·Ø¨Ø§Ø¹Ø©: Ù†ÙØªØ­ ÙÙŠ Ù†Ø§ÙØ°Ø© ÙˆÙ†Ø³ØªØ¯Ø¹ÙŠ print()
      async function printPdf() {
        const url = await exportPdfBlobUrl();
        const win = window.open(url);
        if (!win) {
          alert('ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨ÙØªØ­ Ø§Ù„Ù†ÙˆØ§ÙØ° Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©.');
          return;
        }
        // Ù†Ù†ØªØ¸Ø± ÙØªØ­ Ø§Ù„Ù†Ø§ÙØ°Ø© Ø«Ù… Ù†Ø·Ø¨Ø¹
        const onLoad = () => {
          win.focus();
          win.print();
        };
        if (win.document.readyState === 'complete') {
          onLoad();
        } else {
          win.onload = onLoad;
        }
      }

      // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ù†Ø¯ Ø¨Ø¯Ø¡ Ø§Ù„ØµÙØ­Ø©
      document.addEventListener('DOMContentLoaded', loadPhoneData);

      // Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ø£Ø²Ø±Ø§Ø±
      btnDownload?.addEventListener('click', (e) => { e.preventDefault(); downloadPdf(); });
      btnPrint?.addEventListener('click', (e) => { e.preventDefault(); printPdf(); });
    })();
  </script>
</body>
</html>
