<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª â€” Ø§Ù„ØµÙ‚Ø±ÙŠ Ù„Ù„Ø§ØªØµØ§Ù„Ø§Øª</title>

  <!-- Ù†ÙØ³ Ø§Ù„Ø®Ø·/Ø§Ù„Ù…ÙƒØªØ¨Ø§Øª -->
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

  <style>
    body { font-family: 'Cairo', sans-serif; background-color: #f8f9fa; padding-top: 70px; }
    .navbar { 
      background-color: #2c3e50; 
      position: fixed; 
      top: 0; 
      width: 100%; 
      z-index: 1030; 
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .navbar-brand, .nav-link { color: white !important; }
    .card { margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.08); }
    .card-header { font-weight: 600; }
    .table thead.table-dark th { vertical-align: middle; }
  </style>
</head>
<body>

  <!-- Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ†Ù‚Ù„ -->
  <nav class="navbar navbar-expand-lg navbar-dark">
    <div class="container">
      <a class="navbar-brand" href="index.html">Ø§Ù„ØµÙ‚Ø±ÙŠ Ù„Ù„Ø§ØªØµØ§Ù„Ø§Øª</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
        <span class="navbar-toggler-icon"></span>
      </button>

      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav me-auto">
          <li class="nav-item">
            <a class="nav-link" href="dashboard.html"><i class="fas fa-tachometer-alt"></i> Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</a>
          </li>

          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" id="inventoryDropdown" role="button" data-bs-toggle="dropdown">
              <i class="fas fa-boxes"></i> Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø®Ø²ÙˆÙ†
            </a>
            <ul class="dropdown-menu">
              <li><a class="dropdown-item" href="inventory_summary.html"><i class="fas fa-chart-bar"></i> Ù…Ù„Ø®Øµ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</a></li>
              <li><a class="dropdown-item" href="search.html"><i class="fas fa-search"></i> Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</a></li>
              <li><hr class="dropdown-divider"></li>
              <li><a class="dropdown-item" href="add_accessory.html"><i class="fas fa-plus"></i> Ø¥Ø¶Ø§ÙØ© Ø£ÙƒØ³Ø³ÙˆØ§Ø±</a></li>
              <li><a class="dropdown-item" href="list_accessories_simple.html"><i class="fas fa-box"></i> Ù…Ø®Ø²ÙˆÙ† Ø§Ù„Ø£ÙƒØ³Ø³ÙˆØ§Ø±Ø§Øª</a></li>
            </ul>
          </li>

          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" id="salesDropdown" role="button" data-bs-toggle="dropdown">
              <i class="fas fa-shopping-cart"></i> Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª
            </a>
            <ul class="dropdown-menu">
              <li><a class="dropdown-item active" href="list_sales.html"><i class="fas fa-list"></i> Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</a></li>
              <li><a class="dropdown-item" href="create_sale.html"><i class="fas fa-plus-circle"></i> Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ù…Ù„ÙŠØ© Ø¨ÙŠØ¹ Ø¬Ø¯ÙŠØ¯Ø©</a></li>
            </ul>
          </li>

          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" id="phoneDropdown" role="button" data-bs-toggle="dropdown">
              <i class="fas fa-mobile-alt"></i> Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù‡ÙˆØ§ØªÙ
            </a>
            <ul class="dropdown-menu">
              <li><a class="dropdown-item" href="add_new_phone.html"><i class="fas fa-mobile"></i> Ù‡Ø§ØªÙ Ø¬Ø¯ÙŠØ¯</a></li>
              <li><a class="dropdown-item" href="add_used_phone.html"><i class="fas fa-mobile-alt"></i> Ù‡Ø§ØªÙ Ù…Ø³ØªØ¹Ù…Ù„</a></li>
            </ul>
          </li>

          <li class="nav-item">
            <a class="nav-link" href="#" onclick="logout()"><i class="fas fa-sign-out-alt"></i> ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</a>
          </li>
        </ul>
      </div>
    </div>
  </nav>

<div class="container mt-4">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="fas fa-shopping-cart"></i> Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</h2>
    <div>
      <a href="create_sale.html" class="btn btn-success me-2">
        <i class="fas fa-plus"></i> Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ù…Ù„ÙŠØ© Ø¨ÙŠØ¹ Ø¬Ø¯ÙŠØ¯Ø©
      </a>
      <a href="dashboard.html" class="btn btn-secondary">
        <i class="fas fa-arrow-left"></i> Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…
      </a>
    </div>
  </div>

  <!-- Ù…Ù†Ø·Ù‚Ø© Ø§Ù„ØªØµÙÙŠØ© -->
  <div class="card mb-4">
    <div class="card-header bg-primary text-white">
      <h5 class="mb-0"><i class="fas fa-filter"></i> ØªØµÙÙŠØ© Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</h5>
    </div>
    <div class="card-body">
      <form id="filterForm" class="row g-3" action="#" onsubmit="applyFilter(); return false;">
        <div class="col-md-3">
          <label for="filter_type" class="form-label">Ù†ÙˆØ¹ Ø§Ù„ØªØµÙÙŠØ©</label>
          <select class="form-select" id="filter_type" name="filter_type" onchange="toggleDateInput()">
            <option value="all">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</option>
            <option value="day">ÙŠÙˆÙ… Ù…Ø­Ø¯Ø¯</option>
            <option value="month">Ø´Ù‡Ø± Ù…Ø­Ø¯Ø¯</option>
            <option value="year">Ø³Ù†Ø© Ù…Ø­Ø¯Ø¯Ø©</option>
          </select>
        </div>

        <!-- Day -->
        <div class="col-md-3" id="day_filter_container" style="display:none;">
          <label for="filter_date" class="form-label">Ø§Ù„ØªØ§Ø±ÙŠØ®</label>
          <input type="date" class="form-control" id="filter_date" name="filter_date" value="">
        </div>

        <!-- Month -->
        <div class="col-md-6" id="month_filter_container" style="display:none;">
          <div class="row">
            <div class="col-md-6">
              <label for="filter_month_year" class="form-label">Ø§Ù„Ø³Ù†Ø©</label>
              <select class="form-select" id="filter_month_year" name="filter_month_year">
                <option value="">Ø§Ø®ØªØ± Ø§Ù„Ø³Ù†Ø©</option>
              </select>
            </div>
            <div class="col-md-6">
              <label for="filter_month_month" class="form-label">Ø§Ù„Ø´Ù‡Ø±</label>
              <select class="form-select" id="filter_month_month" name="filter_month_month">
                <option value="">Ø§Ø®ØªØ± Ø§Ù„Ø´Ù‡Ø±</option>
                <option value="01">ÙŠÙ†Ø§ÙŠØ±</option>
                <option value="02">ÙØ¨Ø±Ø§ÙŠØ±</option>
                <option value="03">Ù…Ø§Ø±Ø³</option>
                <option value="04">Ø£Ø¨Ø±ÙŠÙ„</option>
                <option value="05">Ù…Ø§ÙŠÙˆ</option>
                <option value="06">ÙŠÙˆÙ†ÙŠÙˆ</option>
                <option value="07">ÙŠÙˆÙ„ÙŠÙˆ</option>
                <option value="08">Ø£ØºØ³Ø·Ø³</option>
                <option value="09">Ø³Ø¨ØªÙ…Ø¨Ø±</option>
                <option value="10">Ø£ÙƒØªÙˆØ¨Ø±</option>
                <option value="11">Ù†ÙˆÙÙ…Ø¨Ø±</option>
                <option value="12">Ø¯ÙŠØ³Ù…Ø¨Ø±</option>
              </select>
            </div>
          </div>
        </div>

        <!-- Year -->
        <div class="col-md-3" id="year_filter_container" style="display:none;">
          <label for="filter_year" class="form-label">Ø§Ù„Ø³Ù†Ø©</label>
          <select class="form-select" id="filter_year" name="filter_year">
            <option value="">Ø§Ø®ØªØ± Ø§Ù„Ø³Ù†Ø©</option>
          </select>
        </div>

        <div class="col-md-3">
          <label class="form-label">&nbsp;</label>
          <div>
            <button type="submit" class="btn btn-primary">
              <i class="fas fa-search"></i> ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªØµÙÙŠØ©
            </button>
            <button type="button" class="btn btn-secondary" onclick="resetFilter()">
              <i class="fas fa-undo"></i> Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ†
            </button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <!-- Ù…Ù„Ø®Øµ Ø§Ù„ØªØµÙÙŠØ© Ø§Ù„Ø­Ø§Ù„ÙŠØ© -->
  <div id="active_filter_alert" class="alert alert-info mb-4 d-none">
    <h6 class="alert-heading mb-0">
      <i class="fas fa-filter"></i>
      <strong>Ø§Ù„ØªØµÙÙŠØ© Ø§Ù„Ø­Ø§Ù„ÙŠØ©:</strong>
      <span id="active_filter_text"></span>
    </h6>
  </div>

  <!-- Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª -->
  <div id="sales_block" class="card d-none">
    <div class="card-header">
      <h5 class="mb-0">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø¨ÙŠØ¹: <span id="total_sales_count">0</span></h5>
    </div>
    <div class="card-body">
      <div class="table-responsive">
        <table class="table table-striped table-hover">
          <thead class="table-dark">
            <tr>
              <th>Ø±Ù‚Ù… Ø§Ù„Ø¹Ù…Ù„ÙŠØ©</th>
              <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
              <th>Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„</th>
              <th>Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</th>
              <th>Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
              <th>Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹</th>
              <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
              <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
            </tr>
          </thead>
          <tbody id="sales_tbody">
            <!-- ØªÙÙ…Ù„Ø£ Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ§Ù‹ -->
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„ØªÙ„Ø®ÙŠØµÙŠØ© -->
  <div id="summary_cards" class="row mt-4 d-none">
    <div class="col-md-3">
      <div class="card bg-primary text-white">
        <div class="card-body text-center">
          <h5 class="card-title">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø¨ÙŠØ¹</h5>
          <h3 id="sum_total_sales_count">0</h3>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card bg-success text-white">
        <div class="card-body text-center">
          <h5 class="card-title">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</h5>
          <h3><span id="sum_total_sales_amount">0.00</span> Ø±ÙŠØ§Ù„</h3>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card bg-info text-white">
        <div class="card-body text-center">
          <h5 class="card-title">Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ù‚Ø¨Ù„ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©</h5>
          <h3><span id="sum_total_sales_subtotal">0.00</span> Ø±ÙŠØ§Ù„</h3>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card bg-warning text-white">
        <div class="card-body text-center">
          <h5 class="card-title">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©</h5>
          <h3><span id="sum_total_vat_amount">0.00</span> Ø±ÙŠØ§Ù„</h3>
        </div>
      </div>
    </div>
  </div>

  <!-- Ø­Ø§Ù„Ø© Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ Ø¨ÙŠØ§Ù†Ø§Øª -->
  <div id="empty_state" class="card d-none">
    <div class="card-body text-center py-5">
      <i class="fas fa-shopping-cart fa-3x text-muted mb-3"></i>
      <h4 class="text-muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¨ÙŠØ¹Ø§Øª</h4>
      <p class="text-muted" id="empty_state_text">Ù„Ù… ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø£ÙŠ Ù…Ø¨ÙŠØ¹Ø§Øª Ø¨Ø¹Ø¯</p>
      <a href="create_sale.html" class="btn btn-primary">
        <i class="fas fa-plus"></i> Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ù…Ù„ÙŠØ© Ø¨ÙŠØ¹ Ø¬Ø¯ÙŠØ¯Ø©
      </a>
    </div>
  </div>
</div>

<!-- Ù…ÙƒØªØ¨Ø§Øª JS Ù†ÙØ³Ù‡Ø§ -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<!-- Firebase Configuration -->
<script type="module" src="js/firebase-config.js"></script>
<script type="module" src="js/firebase-database.js"></script>
<script type="module" src="js/firebase-storage-manager.js"></script>

<!-- Firebase Integration: Load sales from database -->
<script>
  // ---------- Ù…ØªØºÙŠØ±Ø§Øª Ø¹Ø§Ù…Ø© ----------
  let salesAll = [];
  let currentFilteredSales = [];

  // ---------- ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Firebase ----------
  async function loadSalesFromFirebase() {
    try {
      console.log('ğŸ”„ ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ù…Ù† Firebase...');
      
      if (window.storage && window.storage.isFirebaseAvailable) {
        // ØªØ­Ù…ÙŠÙ„ Ù…Ù† Firebase
        const sales = await window.storage.getSales();
        if (sales && Array.isArray(sales)) {
          salesAll = sales;
          console.log('âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ù…Ù† Firebase:', salesAll.length);
        } else {
          salesAll = [];
          console.log('âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¨ÙŠØ¹Ø§Øª ÙÙŠ Firebase');
        }
      } else {
        // ØªØ­Ù…ÙŠÙ„ Ù…Ù† localStorage ÙƒØ¨Ø¯ÙŠÙ„
        console.log('ğŸ’¾ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ù…Ù† localStorage...');
        const sales = JSON.parse(localStorage.getItem('sales') || '[]');
        salesAll = sales;
        console.log('âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ù…Ù† localStorage:', salesAll.length);
      }
      
      // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªØµÙÙŠØ© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
      applyCurrentFilter();
      
    } catch (error) {
      console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª:', error);
      salesAll = [];
      showAlert('danger', 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª');
    }
  }

  // ---------- ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªØµÙÙŠØ© Ø§Ù„Ø­Ø§Ù„ÙŠØ© ----------
  function applyCurrentFilter() {
    const type = document.getElementById('filter_type').value;
    let filtered = [...salesAll];
    let summaryText = '';
    let emptyHint = 'Ù„Ù… ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø£ÙŠ Ù…Ø¨ÙŠØ¹Ø§Øª Ø¨Ø¹Ø¯';

    if (type==='day') {
      const val = document.getElementById('filter_date').value;
      if (val) {
        const [y,m,d] = val.split('-').map(Number);
        filtered = salesAll.filter(s => sameDay(s.date_created, y, m, d));
        summaryText = `Ù…Ø¨ÙŠØ¹Ø§Øª ÙŠÙˆÙ… ${convertToLatinNumbers(val)}`;
      }
    } else if (type==='month') {
      const year = parseInt(document.getElementById('filter_month_year').value);
      const month = parseInt(document.getElementById('filter_month_month').value);
      if (year && month) {
        filtered = salesAll.filter(s => sameMonth(s.date_created, year, month));
        summaryText = `Ù…Ø¨ÙŠØ¹Ø§Øª Ø´Ù‡Ø± ${convertToLatinNumbers(month)}/${convertToLatinNumbers(year)}`;
      }
    } else if (type==='year') {
      const year = parseInt(document.getElementById('filter_year').value);
      if (year) {
        filtered = salesAll.filter(s => sameYear(s.date_created, year));
        summaryText = `Ù…Ø¨ÙŠØ¹Ø§Øª Ø³Ù†Ø© ${convertToLatinNumbers(year)}`;
      }
    }

    currentFilteredSales = filtered;
    renderSales(filtered, type, summaryText, emptyHint);
  }

  // ---------- Ø£Ø¯ÙˆØ§Øª ----------
  const fmtMoney = n => convertToLatinNumbers((Number(n)||0).toFixed(2));
  function formatDateTime(iso) {
    // ÙŠÙØ¸Ù‡Ø± Ø¨ØµÙŠØºØ© YYYY-MM-DD HH:mm Ø¨Ø£Ø±Ù‚Ø§Ù… Ù„Ø§ØªÙŠÙ†ÙŠØ©
    if (!iso) return '-';
    
    const d = new Date(iso);
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„ØªØ§Ø±ÙŠØ®
    if (isNaN(d.getTime())) {
      console.warn('âš ï¸ Invalid date:', iso);
      return '-';
    }
    
    const pad = x => String(x).padStart(2,'0');
    const year = d.getFullYear();
    const month = pad(d.getMonth() + 1);
    const day = pad(d.getDate());
    const hours = pad(d.getHours());
    const minutes = pad(d.getMinutes());
    
    // ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø¥Ù„Ù‰ Ù„Ø§ØªÙŠÙ†ÙŠØ©
    const latinYear = convertToLatinNumbers(year.toString());
    const latinMonth = convertToLatinNumbers(month);
    const latinDay = convertToLatinNumbers(day);
    const latinHours = convertToLatinNumbers(hours);
    const latinMinutes = convertToLatinNumbers(minutes);
    
    return `${latinYear}-${latinMonth}-${latinDay} ${latinHours}:${latinMinutes}`;
  }
  
  // ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø¥Ù„Ù‰ Ù„Ø§ØªÙŠÙ†ÙŠØ©
  function convertToLatinNumbers(str) {
    if (!str) return str;
    const arabicToLatin = {
      'Ù ': '0', 'Ù¡': '1', 'Ù¢': '2', 'Ù£': '3', 'Ù¤': '4',
      'Ù¥': '5', 'Ù¦': '6', 'Ù§': '7', 'Ù¨': '8', 'Ù©': '9'
    };
    return str.replace(/[Ù -Ù©]/g, digit => arabicToLatin[digit] || digit);
  }
  function sameDay(iso, y, m, d) {
    if (!iso) return false;
    const dt = new Date(iso);
    if (isNaN(dt.getTime())) return false;
    return dt.getFullYear()===y && (dt.getMonth()+1)===m && dt.getDate()===d;
  }
  function sameMonth(iso, y, m) {
    if (!iso) return false;
    const dt = new Date(iso);
    if (isNaN(dt.getTime())) return false;
    return dt.getFullYear()===y && (dt.getMonth()+1)===m;
  }
  function sameYear(iso, y) {
    if (!iso) return false;
    const dt = new Date(iso);
    if (isNaN(dt.getTime())) return false;
    return dt.getFullYear()===y;
  }

  // ---------- ØªØ¹Ø¨Ø¦Ø© Ø³Ù†ÙˆØ§Øª Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… ----------
  function populateYears() {
    const yearNow = new Date().getFullYear();
    const years = [];
    for (let y=yearNow+2; y>=yearNow-10; y--) years.push(y);

    const selYear1 = document.getElementById('filter_month_year');
    const selYear2 = document.getElementById('filter_year');
    years.forEach(y => {
      const o1 = document.createElement('option'); o1.value = y; o1.textContent = y; selYear1.appendChild(o1);
      const o2 = document.createElement('option'); o2.value = y; o2.textContent = y; selYear2.appendChild(o2);
    });
  }

  // ---------- Ù…Ù†Ø·Ù‚ Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ Ø¨ÙŠÙ† Ù…Ø¯Ø®Ù„Ø§Øª Ø§Ù„ØªØ§Ø±ÙŠØ® ----------
  function toggleDateInput() {
    const type = document.getElementById('filter_type').value;
    const dayC = document.getElementById('day_filter_container');
    const monC = document.getElementById('month_filter_container');
    const yearC = document.getElementById('year_filter_container');
    dayC.style.display = 'none'; monC.style.display = 'none'; yearC.style.display = 'none';
    if (type==='day') dayC.style.display = 'block';
    else if (type==='month') monC.style.display = 'block';
    else if (type==='year') yearC.style.display = 'block';
  }

  // ---------- ØªØ·Ø¨ÙŠÙ‚/Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØµÙÙŠØ© ----------
  function applyFilter() {
    applyCurrentFilter();
  }

  function resetFilter() {
    document.getElementById('filterForm').reset();
    toggleDateInput();
    applyCurrentFilter();
  }

  // ---------- Ø§Ù„Ø¹Ø±Ø¶ ----------
  function renderSales(sales, type='all', summaryText='', emptyHint='Ù„Ù… ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø£ÙŠ Ù…Ø¨ÙŠØ¹Ø§Øª Ø¨Ø¹Ø¯') {
    const hasData = sales && sales.length>0;

    // Ù…Ù„Ø®Øµ Ø§Ù„ØªØµÙÙŠØ©
    const alertBox = document.getElementById('active_filter_alert');
    const alertText = document.getElementById('active_filter_text');
    if (type!=='all' && summaryText) {
      alertText.textContent = summaryText;
      alertBox.classList.remove('d-none');
    } else {
      alertBox.classList.add('d-none');
      alertText.textContent = '';
    }

    // Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø¨Ù„ÙˆÙƒØ§Øª
    document.getElementById('sales_block').classList.toggle('d-none', !hasData);
    document.getElementById('summary_cards').classList.toggle('d-none', !hasData);
    document.getElementById('empty_state').classList.toggle('d-none', hasData);

    // Ù†Øµ Ø­Ø§Ù„Ø© ÙØ§Ø±ØºØ©
    document.getElementById('empty_state_text').textContent = (type!=='all') ? 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¨ÙŠØ¹Ø§Øª ØªØ·Ø§Ø¨Ù‚ Ù…Ø¹Ø§ÙŠÙŠØ± Ø§Ù„ØªØµÙÙŠØ© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©' : emptyHint;

    if (!hasData) return;

    // ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø¬Ø¯ÙˆÙ„
    const tbody = document.getElementById('sales_tbody');
    tbody.innerHTML = '';
    let totalSubtotal = 0, totalVat = 0, totalAmount = 0;

    sales.forEach(sale => {
      totalSubtotal += sale.subtotal || 0;
      totalVat      += sale.vat_amount || 0;
      totalAmount   += sale.total_amount || 0;

      const tr = document.createElement('tr');

      // Ø±Ù‚Ù… Ø§Ù„Ø¹Ù…Ù„ÙŠØ©
      const tdNum = document.createElement('td');
      tdNum.innerHTML = `<span class="badge bg-primary">${sale.sale_number}</span>`;
      tr.appendChild(tdNum);

      // Ø§Ù„ØªØ§Ø±ÙŠØ®
      const tdDate = document.createElement('td');
      let saleDate = sale.date_created || sale.date_added;
      
      // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙˆØ¬Ø¯ ØªØ§Ø±ÙŠØ®ØŒ Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ø­Ø§Ù„ÙŠ
      if (!saleDate) {
        console.warn('âš ï¸ No date found for sale:', sale.id, 'using current date');
        saleDate = new Date().toISOString();
      }
      
      console.log('ğŸ” Sale date fields:', {
        id: sale.id,
        date_created: sale.date_created,
        date_added: sale.date_added,
        selectedDate: saleDate
      });
      tdDate.textContent = formatDateTime(saleDate);
      tr.appendChild(tdDate);

      // Ø§Ù„Ø¹Ù…ÙŠÙ„
      const tdCust = document.createElement('td');
      tdCust.textContent = sale.customer_name || 'Ø¹Ù…ÙŠÙ„ Ù†Ù‚Ø¯ÙŠ';
      tr.appendChild(tdCust);

      // Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª
      const tdItems = document.createElement('td');
      const count = sale.items ? sale.items.length : 0;
      tdItems.innerHTML = `<span class="badge bg-info">${count}</span>`;
      tr.appendChild(tdItems);

      // Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ + ØªÙØ§ØµÙŠÙ„
      const tdAmt = document.createElement('td');
      tdAmt.innerHTML = `
        <span class="fw-bold text-success">${fmtMoney(sale.total_amount)} Ø±ÙŠØ§Ù„</span>
        <br>
        <small class="text-muted">
          Ù‚Ø¨Ù„ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©: ${fmtMoney(sale.subtotal)} Ø±ÙŠØ§Ù„
          <br>
          Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©: ${fmtMoney(sale.vat_amount)} Ø±ÙŠØ§Ù„
        </small>`;
      tr.appendChild(tdAmt);

      // Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹
      const tdPay = document.createElement('td');
      tdPay.textContent = sale.payment_method || '-';
      tr.appendChild(tdPay);

      // Ø§Ù„Ø­Ø§Ù„Ø© (Ø´Ø§Ø±Ø©)
      const tdStatus = document.createElement('td');
      let badge = 'bg-warning';
      if (sale.status === 'Ù…ÙƒØªÙ…Ù„') badge = 'bg-success';
      else if (sale.status === 'Ù…Ù„ØºÙŠ') badge = 'bg-danger';
      tdStatus.innerHTML = `<span class="badge ${badge}">${sale.status || '-'}</span>`;
      tr.appendChild(tdStatus);

      // Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª
      const tdAct = document.createElement('td');
      tdAct.innerHTML = `
        <div class="btn-group" role="group">
          <a href="view_sale.html?id=${encodeURIComponent(sale.id)}"
             class="btn btn-sm btn-info" title="Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„">
            <i class="fas fa-eye"></i>
          </a>
          <button class="btn btn-sm btn-success" onclick="window.print()" title="Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ÙØ§ØªÙˆØ±Ø©">
            <i class="fas fa-print"></i>
          </button>
        </div>
      `;
      tr.appendChild(tdAct);

      tbody.appendChild(tr);
    });

    // Ø§Ù„Ø±Ø£Ø³ + Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª
    document.getElementById('total_sales_count').textContent = sales.length;
    document.getElementById('sum_total_sales_count').textContent = sales.length;
    document.getElementById('sum_total_sales_amount').textContent = fmtMoney(totalAmount);
    document.getElementById('sum_total_sales_subtotal').textContent = fmtMoney(totalSubtotal);
    document.getElementById('sum_total_vat_amount').textContent = fmtMoney(totalVat);
  }

  // ---------- Ø¹Ø±Ø¶ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª ----------
  function showAlert(type, message) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
    alertDiv.innerHTML = `
      ${message}
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    // Ø¥Ø¯Ø±Ø§Ø¬ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ ÙÙŠ Ø£Ø¹Ù„Ù‰ Ø§Ù„ØµÙØ­Ø©
    const container = document.querySelector('.container');
    container.insertBefore(alertDiv, container.firstChild);
    
    // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¨Ø¹Ø¯ 5 Ø«ÙˆØ§Ù†
    setTimeout(() => {
      if (alertDiv.parentNode) {
        alertDiv.remove();
      }
    }, 5000);
  }

  // ---------- ØªÙ‡ÙŠØ¦Ø© ----------
  // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
  function logout() {
    if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ØŸ')) {
      localStorage.removeItem('current_user');
      alert('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ø¨Ù†Ø¬Ø§Ø­');
      window.location.href = 'index.html';
    }
  }

  document.addEventListener('DOMContentLoaded', async () => {
    populateYears();
    toggleDateInput();
    
    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Firebase
    await loadSalesFromFirebase();
  });
</script>
</body>
</html>
